<!DOCTYPE html>
<html>
  <head>
    <meta charset="UTF-8" />
    <title></title>

    <script>
      function jaccard(str1, str2) {
        const set1 = new Set(str1.split(""));
        const set2 = new Set(str2.split(""));
        const intersection = new Set([...set1].filter((x) => set2.has(x)));
        const union = new Set([...set1, ...set2]);
        return intersection.size / union.size;
      }

      function findMatchingWord(similarityThreshold) {
        const word1 = document.getElementById("word1").value.toLowerCase();
        let word2Promise = fetch("https://localhost:7124/Names")
          .then((response) => response.json())
          .then((data) => {
            // Convert all words in the data array to lowercase
            return data.map((word) => word.toLowerCase());
          })
          .catch((error) => {
            console.error("Error:", error);
          });
        let matchingWords = new Set(); // use a set instead of an array
        const words1 = word1.split(" ");
        word2Promise.then((word2) => {
          // `word2` is now an array of strings returned by the API, all in lowercase
          for (let i = 0; i < words1.length; i++) {
            for (let j = 0; j < word2.length; j++) {
              const words2 = word2[j].split(" ");
              for (let k = 0; k < words2.length; k++) {
                const similarity = jaccard(words1[i], words2[k]);
                if (similarity >= similarityThreshold) {
                  matchingWords.add(word2[j]); // add to the set instead of push to the array
                  break;
                }
              }
            }
          }
          if (matchingWords.size > 0) {
            const matchingString = Array.from(matchingWords).join("///"); // convert the set to an array for display
            document.getElementById(
              "result"
            ).innerHTML = `\n ${matchingString}`;
          } else document.getElementById("result").innerHTML = "No words.";
        });
      }

      function query() {
        var vesselitemid = document.getElementById("vesselitemid").value;
        var masterid = document.getElementById("pritemid").value;
        var vesselnumber = document.getElementById("vesselnumber").value;
        var queryone = (document.getElementById(
          "query1"
        ).innerHTML = `update pr_item_details set item_id= '${vesselitemid}' where item_id ='${masterid}'
        and pr_master_id in (select id from pr_master where vessel_id= ${vesselnumber});`);

        var querytwo = (document.getElementById(
          "query2"
        ).innerHTML = `update quote_item_details set item_id= '${vesselitemid}' where item_id ='${masterid}'
        and quote_master_id in (select id from quote_master where vessel_id= ${vesselnumber});`);

        var querythree = (document.getElementById(
          "query3"
        ).innerHTML = `update po_item_details set item_id= '${vesselitemid}' where item_id ='${masterid}'
        and po_master_id in (select id from po_master where vessel_id= ${vesselnumber});`);

        var queryfour = (document.getElementById(
          "query4"
        ).innerHTML = `update stock_items set item_id= '${vesselitemid}' where item_id ='${masterid}'
        and stock_master_id in (select id from stock_master where vessel_id= ${vesselnumber});`);
        
        var queryfive = (document.getElementById(
          "query4"
        ).innerHTML = `delete from item_vessel_mapping where item_id='${data.vesselItemId}' and vessel_id=${vesselnumber};`);
        
        var querysix = (document.getElementById(
          "query4"
        ).innerHTML = `delete from item_master where id='${data.vesselItemId};'`);

      }

      function submitForm() {
        const vesselItemName = document.getElementById("vesselname").value;
        const PrItemName = document.getElementById("prname").value;

        fetch("https://localhost:7124/GetId", {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
          },
          body: JSON.stringify({ vesselItemName, PrItemName }),
        })
          .then((response) => response.json())
          .then((data) => {
            console.log(data);
            document.getElementById("vesselitemid").innerHTML =
              data.vesselItemId;
            document.getElementById("pritemid").innerHTML = data.prItemID;
            const vesselnumber = document.getElementById("vesselnumber").value;

            var queryone = (document.getElementById(
              "query1"
            ).innerHTML = `update pr_item_details set item_id= '${data.prItemID}' where item_id = '${data.vesselItemId}'
        and pr_master_id in (select id from pr_master where vessel_id = ${vesselnumber});`);
            var querytwo = (document.getElementById(
              "query2"
            ).innerHTML = `update quote_item_details set item_id= '${data.prItemID}' where item_id = '${data.vesselItemId}'
        and quote_master_id in (select id from quote_master where vessel_id = ${vesselnumber});`);

            var querythree = (document.getElementById(
              "query3"
            ).innerHTML = `update po_item_details set item_id= '${data.prItemID}' where item_id = '${data.vesselItemId}'
        and po_master_id in (select id from po_master where vessel_id = ${vesselnumber});`);

            var queryfour = (document.getElementById(
              "query4"
            ).innerHTML = `update stock_items set item_id= '${data.prItemID}' where item_id = '${data.vesselItemId}'
        and stock_master_id in (select id from stock_master where vessel_id = ${vesselnumber});`);
        
        var queryfive = (document.getElementById(
          "query5"
        ).innerHTML = `delete from item_vessel_mapping where item_id='${data.vesselItemId}' and vessel_id=${vesselnumber};`);
        
        var querysix = (document.getElementById(
          "query6"
        ).innerHTML = `delete from item_master where id='${data.vesselItemId}';`);
        
            document.getElementById("saver").innerHTML =
              "Click Button to Save to file";
          })

          .catch((error) => console.error(error));
      }
      function SaveToQuery() {
        const vesselItemName = document.getElementById("vesselname").value;
        const PrItemName = document.getElementById("prname").value;

        fetch("https://localhost:7124/GetId", {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
          },
          body: JSON.stringify({ vesselItemName, PrItemName }),
        })
          .then((response) => response.json())
          .then((data) => {
            console.log(data);
            document.getElementById("vesselitemid").innerHTML =
              data.vesselItemId;
            document.getElementById("pritemid").innerHTML = data.prItemID;
            const vesselnumber = document.getElementById("vesselnumber").value;

            var queryone = (document.getElementById(
              "query1"
            ).innerHTML = `update pr_item_details set item_id= '${data.prItemID}' where item_id ='${data.vesselItemId}' and pr_master_id in (select id from pr_master where vessel_id = ${vesselnumber});`);
            var querytwo = (document.getElementById(
              "query2"
            ).innerHTML = `update quote_item_details set item_id= '${data.prItemID}' where item_id ='${data.vesselItemId}' and quote_master_id in (select id from quote_master where vessel_id = ${vesselnumber});`);

            var querythree = (document.getElementById(
              "query3"
            ).innerHTML = `update po_item_details set item_id= '${data.prItemID}' where item_id ='${data.vesselItemId}' and po_master_id in (select id from po_master where vessel_id = ${vesselnumber});`);

            var queryfour = (document.getElementById(
              "query4"
            ).innerHTML = `update stock_items set item_id= '${data.prItemID}' where item_id ='${data.vesselItemId}' and stock_master_id in (select id from stock_master where vessel_id = ${vesselnumber});`);

            var queryfive = (document.getElementById("query5").innerHTML = `delete from item_vessel_mapping where item_id='${data.vesselItemId}' and vessel_id=${vesselnumber};`);
        
            var querysix = (document.getElementById("query6").innerHTML = `delete from item_master where id='${data.vesselItemId}';`);
            const queryData = {
              queryone,
              querytwo,
              querythree,
              queryfour,
              queryfive,
              querysix,
              vesselnumber,
            };
            fetch("https://localhost:7124/Querywrite", {
              method: "POST",
              headers: {
                "Content-Type": "application/json",
              },
              body: JSON.stringify(queryData),
            })
              .then((response) => response.json())
              .then((data) => {
                console.log(data);
              })
              .catch((error) => console.error(error));
          })
          .catch((error) => console.error(error));
      }
    </script>
  </head>

  <body>
    <h1></h1>
    <label for="word1">Vessil Item</label>
    <input type="text" id="word1" name="word1" /><br />
    <br />
    <label for="word2">Provision Item</label> <br />
    <br />
    <button onclick="findMatchingWord(0.9)">90</button>
    <button onclick="findMatchingWord(0.7)">70</button>
    <button onclick="findMatchingWord(0.6)">60</button>
    <button onclick="findMatchingWord(0.5)">50</button>
    <p id="result"></p>
    <br />
    <h1>------------------</h1>
    <label for="update">GET ID</label>
    <br /><br />

    <form id="myForm">
      <label for="vesselname">vessel item name</label>
      <input type="text" id="vesselname" name="vesselname" />
      <label for="prname">Pr Item name</label>
      <input type="text" id="prname" name="prname" />
      <label for="vesselnumber">Vessel Number</label>
      <input type="text" id="vesselnumber" name="vesselnumber" /><br /><br />
      <br />
      <button type="button" onclick="submitForm()">Submit</button>
      <br /><br />
      <div id="saver"></div>
      <br />
      <button type="button" onclick="SaveToQuery()">Save To Query</button>
    </form>
    <p>Vessel item id</p>
    <div id="vesselitemid"></div>
    <br />
    <p>Pr Item id</p>
    <div id="pritemid"></div>
    <h1>------------------</h1>

    <!-- <br /><br />
    <label for="update">Update Query Gen</label>
    <br /><br />
    <input type="text" id="vesselid" placeholder="Vessel item Id" />
    <input type="text" id="masterid" placeholder="Provision master item Id" />
    <input type="text" id="vesselnumber" placeholder="Vessel Number" />
    <button onclick="query()">Generate Query</button><br /><br /> -->
    <div id="query1"></div>
    <div id="query2"></div>
    <div id="query3"></div>
    <div id="query4"></div>
    <div id="query5"></div>
    <div id="query6"></div>
  </body>
</html>
